---
title: Staking API Webhooks
sidebar_position: 3
---

import Link from "@docusaurus/Link";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## Motivation

A webhook is an HTTP request which triggers by an event in a source system (ex. Figment's Staking API) and sent to a destination system (ex. Cloudflare Worker) with a payload of data. In general, webhooks are a way to send automated messages between systems whenever a new event takes place.

The Staking API uses webhooks to send notifications about events related to the various Staking API flows. For example, when an undelegation flow is completed, a webhook can be sent to the server of your choosing.

There are some security considerations when dealing with webhooks.
This guide provides all the information needed to successfully manage webhooks in the context of Figment's Staking API.

We will examine how serverless functions (Cloudflare Workers) can be beneficial to this process, and provide example code which can be used as the basis for your own solution.

:::note

If your particular language and server implementation specifies a character encoding, ensure that you handle the payload as UTF-8.
JSON is encoded as UTF-8 by default.

:::

### Code Explanation

Secure your webhook with a client signature to validate that the Staking API generated the webhook you are consuming and that it didn't come from a malicious origin.

Webhooks from the Staking API are sent with the `Slate-Signature` header, which you can use to verify the payload. The value will look like this:

```text
t=1666214090,v1=f790a584722ff6c0ebf4e9b59835ba5b93ee824ae0a7164feba30953d6b52cee
```

- `t` is a UNIX Epoch timestamp.
- `v1` is the signature string that you can use.

### HMAC

In cryptography, an HMAC is a specific type of message authentication code. HMAC stands for **Hashed or Hash-based Message Authentication Code**.

## Listening for Webhooks With Cloudflare

We'll be using a serverless function on Cloudflare to capture, inspect, and manage a webhook response payload from the Staking API.
Cloudflare Workers provide flexibility and scalability when handling webhooks sent by the Staking API.

<details><summary>Click here to view the code.</summary>

```js title="Sample Cloudflare Worker"
// TBD
```

</details>

A Staking API webhook payload will look something like this:

```bash title="Sample Staking API Webhook Payload"
{
  amount: '10.0',
  status: 'success',
  flow_id: '49a1bab1-e3e6-4f77-8212-ee254e1ab9a3',
  event_type: 'near.transfer.transfer_tx.confirmed',
  transaction_hash: '2a9fnT6j5M9Fy6TFNbX2bA1Ncjh6aXK9Ky8oPBUuJwtS',
  to_account_address: 'pizza.testnet',
  from_account_pubkey: 'ed25519:5QA46X6NkNmsFdu9xWVBaLNowh9gGeF1c5r9u6NcxaLY',
  from_account_address: 'slate-demo.testnet'
}
```

:::info

The fields which are common to all Staking API webhook payloads are `flow_id` and `event_type`.

:::

## References

Learn more about webhook fundamentals in these excellent articles from HookDeck:

- <Link to="https://hookdeck.com/webhooks/guides/what-are-webhooks-how-they-work">
    What Are Webhooks And How They Work
  </Link>
- <Link to="https://hookdeck.com/webhooks/guides/complete-guide-to-webhook-security">
    Complete Guide to Webhook Security
  </Link>
- <Link to="https://hookdeck.com/webhooks/guides/webhooks-security-checklist">
    How to Secure Webhooks &mdash; 5-step Checklist
  </Link>
- <Link to="https://hookdeck.com/webhooks/guides/how-to-implement-sha256-webhook-signature-verification">
    How to Implement SHA256 Webhook Signature Verification
  </Link>

Useful blog posts from other sources:

- <Link to="https://cjav.dev/posts/webhook-trip-hazards/">
    Webhook Trip Hazards
  </Link>
