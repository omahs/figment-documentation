---
title: Staking API Webhooks
sidebar_position: 3
---

import Link from "@docusaurus/Link";
import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

import img1 from "@site/static/img/guides/staking-api/ngrok_console.png";

## Security Overview

In general, webhooks are a way to send automated messages between apps.
There are some security considerations when dealing with webhooks.
This guide provides all the information needed to successfully manage webhooks in the context of Figment's Staking API.

The Staking API uses webhooks to send notifications about events related to the various Staking API flows.
For example, when an undelegation flow is completed, a webhook can be sent to the server of your choosing.

We will examine how serverless functions (Cloudflare Workers) can be beneficial to this process, and provide example code which can be used as the basis for your own solution.

:::note

If your particular language and server implementation specifies a character encoding, ensure that you handle the payload as UTF-8.
JSON is encoded as UTF-8 by default.

:::

<!-- <details><summary>Click here for more details</summary>

Click on the thumbnail image below to view a demonstration recording on ASCIInema (this will open a new tab):
<a href="https://asciinema.org/a/HaZ78Y4wuzJV7ohfmCaNDceW0?autoplay=1"><img src="https://asciinema.org/a/HaZ78Y4wuzJV7ohfmCaNDceW0.png" width="700" className="shadow--tl inline-image"/></a>

</details> -->

### Code Explanation

Secure your webhook with a client signature to validate that the Staking API generated the webhook you are consuming and that it didnâ€™t come from a malicious origin.

Webhooks are sent with the `Slate-Signature` header, which you can use to verify the payload. The value will look like this:

```text
t=1666214090,v1=f790a584722ff6c0ebf4e9b59835ba5b93ee824ae0a7164feba30953d6b52cee
```

- `t` is a UNIX Epoch timestamp.
- `v1` is the signature string that you can use.

### HMAC

## Listening for Webhooks With Cloudflare

We'll be using a serverless function on Cloudflare to capture, inspect, and manage a webhook response payload from the Staking API.
Cloudflare Workers provide flexibility and scalability when handling webhooks sent by the Staking API.

<details><summary>Click here to view the code.</summary>

```js title="Example Cloudflare Worker"
"use strict";
(() => {
  // src/index.ts
  addEventListener("fetch", (event) => {
    event.respondWith(handleRequest(event.request));
  });
  async function handleRequest(request) {
    const headers = request.headers;
    const data = await request.json();
    try {
      if (data) {
        console.log(WEBHOOK_SECRET);

        let sig = headers.get("Slate-Signature");
        console.log(sig);
        let splitsig = sig.split(",");
        console.log("sigsplit", splitsig);
        var uint8array = new TextEncoder().encode(WEBHOOK_SECRET);
        var uint8 = new TextEncoder().encode(splitsig[1]);
        var uint = new TextEncoder().encode(JSON.stringify(data));

        let akey = uint8array;
        console.log(akey);
        console.log(uint8);
        console.log("Encoded data:", uint);
        let ckey = await crypto.subtle.importKey(
          "raw",
          akey,
          { name: "HMAC", hash: "SHA-256" },
          false,
          ["verify"]
        );
        let hmac = await crypto.subtle.verify("HMAC", ckey, uint8, uint);

        console.log("Should be true: ", hmac);

        for (const [key, value] of Object.entries(data)) {
          console.log(`${key}: ${value}`);
        }
        console.log("Request Headers:\n");
        for (var pair of request.headers.entries()) {
          console.log(pair[0] + ": " + pair[1]);
        }
        console.log("Incoming payload:", data);
        return new Response(JSON.stringify(data, null, 2), {
          headers: { "content-type": "text/plain" },
        });
      }
    } catch (error) {
      console.log(error);
      return new Response(error, { headers: { "content-type": "text/plain" } });
    }
  }
})();
//# sourceMappingURL=index.js.map
```

</details>

A Staking API webhook payload will look something like this:

```json title="Sample Staking API Webhook Payload"
{
  "status": "broadcast",
  "flow_id": "3e079c15-befb-4bd2-bdf9-f3e7eaeb182d",
  "event_type": "v1.polkadot.staking.bonding_tx.confirmed",
  "transaction_hash": "0xb59949456f2bbf347011d7da6204b0a3fff4fe05f6905e1bef533e482e9bf346"
}
```

## References

Learn more about webhook fundamentals in these excellent articles from HookDeck:

- <Link to="https://hookdeck.com/webhooks/guides/what-are-webhooks-how-they-work">
    What Are Webhooks And How They Work
  </Link>
- <Link to="https://hookdeck.com/webhooks/guides/complete-guide-to-webhook-security">
    Complete Guide to Webhook Security
  </Link>
- <Link to="https://hookdeck.com/webhooks/guides/webhooks-security-checklist">
    How to Secure Webhooks &mdash; 5-step Checklist
  </Link>
- <Link to="https://hookdeck.com/webhooks/guides/how-to-implement-sha256-webhook-signature-verification">
    How to Implement SHA256 Webhook Signature Verification
  </Link>
- <Link to="https://cjav.dev/posts/webhook-trip-hazards/">
    Webhook Trip Hazards
  </Link>
